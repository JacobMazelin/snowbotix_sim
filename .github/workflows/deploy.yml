name: Deploy to AWS

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.AWS_SSH_KEY }}
          log-public-key: false
      
      - name: Add AWS host to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 18.223.190.83 >> ~/.ssh/known_hosts 2>/dev/null || true
      
      - name: Deploy to AWS
        run: |
          echo "üöÄ Deploying to AWS EC2..."
          echo ""
          
          # Create remote directory if it doesn't exist
          ssh ubuntu@18.223.190.83 "mkdir -p ~/snowbotix_sim"
          
          # Sync files to AWS (excluding .git and other unnecessary files)
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.md' \
            --exclude='.gitignore' \
            --exclude='.devcontainer' \
            ./ ubuntu@18.223.190.83:~/snowbotix_sim/
          
          echo "‚úÖ Files synced successfully"
          echo ""
      
      - name: Build and Restart Simulation
        run: |
          echo "üîß Building and restarting simulation on AWS..."
          echo ""
          
          ssh ubuntu@18.223.190.83 << 'EOF'
            set -e
            cd ~/snowbotix_sim
            
            echo "‚Üí Making scripts executable..."
            chmod +x scripts/*.sh
            chmod +x aws/*.sh 2>/dev/null || true
            
            echo "‚Üí Stopping existing simulation..."
            pkill -f "gz sim" 2>/dev/null || true
            pkill -f "parameter_bridge" 2>/dev/null || true
            sleep 2
            
            echo "‚Üí Syncing with git repository..."
            if [ ! -d .git ]; then
              git init
              git remote add origin https://github.com/JacobMazelin/snowbotix_sim.git
            fi
            git fetch origin main
            git reset --hard origin/main
            
            echo "‚Üí Building custom packages (if any)..."
            if [ -d src ]; then
              source /opt/ros/jazzy/setup.bash
              if [ -f src/CMakeLists.txt ] || ls src/*/package.xml 1> /dev/null 2>&1; then
                echo "  Found packages, building with colcon..."
                # Build any custom packages
                cd ~/snowbotix_sim
                colcon build --symlink-install 2>&1 | tail -20 || echo "  Build completed or no packages to build"
                source install/setup.bash 2>/dev/null || true
              else
                echo "  No packages found to build"
              fi
            fi
            
            echo "‚Üí Starting clock bridge..."
            nohup bash -c 'source /opt/ros/jazzy/setup.bash && source ~/snowbotix_sim/install/setup.bash 2>/dev/null; ros2 run ros_gz_bridge parameter_bridge /clock' > /tmp/clock_bridge.log 2>&1 &
            
            echo "‚Üí Starting simulation..."
            nohup bash -c 'source /opt/ros/jazzy/setup.bash && source ~/snowbotix_sim/install/setup.bash 2>/dev/null; cd ~/snowbotix_sim && ./scripts/run_diff_drive_headless.sh' > /tmp/simulation.log 2>&1 &
            
            echo ""
            echo "‚úÖ Simulation restarted at $(date)"
          EOF
          
          echo ""
          echo "üéâ Deployment complete!"
      
      - name: Verify Deployment
        run: |
          echo "‚è≥ Waiting for simulation to start..."
          sleep 10
          
          echo ""
          echo "üîç Running health check..."
          ssh ubuntu@18.223.190.83 << 'EOF'
            cd ~/snowbotix_sim
            ./scripts/healthcheck.sh 2>&1 | head -50
          EOF
          
          echo ""
          echo "üìä Check live status:"
          echo "   https://github.com/JacobMazelin/snowbotix_sim/actions"
          echo ""
          echo "üåê Your simulation is now live at AWS!"
          echo "   Connect Foxglove to: ws://localhost:8765 (via SSH tunnel)"
      
      - name: Notify Success
        run: |
          echo ""
          echo "========================================"
          echo "  ‚úÖ DEPLOYMENT SUCCESSFUL!"
          echo "========================================"
          echo ""
          echo "üìù Your changes have been deployed to AWS"
          echo "‚è±Ô∏è  Changes will appear in Foxglove in ~30 seconds"
          echo ""
          echo "üîó Useful links:"
          echo "   GitHub Repo: https://github.com/JacobMazelin/snowbotix_sim"
          echo "   GitHub Actions: https://github.com/JacobMazelin/snowbotix_sim/actions"
          echo ""
          echo "üöÄ Happy coding!"
